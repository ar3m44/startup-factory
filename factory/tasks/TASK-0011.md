# TASK-0011: Engineer Runner with Claude API + Auto-merge

**Priority**: P0
**Type**: Feature/Automation
**Dependencies**: TASK-0010

## Context

We want a fully autonomous engineering loop:
TASK file -> GitHub Actions -> Claude API -> patch -> checks -> PR -> auto-merge -> deploy

The basic `scripts/engineer/run-task.mjs` exists but needs refinement for production use.

## Scope

- `scripts/engineer/run-task.mjs` - update/refine
- `scripts/engineer/apply-patch.mjs` - improve robustness
- `scripts/engineer/generate-report.mjs` - ensure complete
- `.github/workflows/engineer.yml` - add auto-merge step
- `factory/spec/PROMPT_ENGINEER.md` - review and update

## Non-Goals

- Do not implement retry logic for API failures (keep simple)
- Do not add complex error recovery
- Do not change CI workflow (only engineer workflow)

## Description

### 1. Update engineer.yml workflow

Add auto-merge step after PR creation:
```yaml
- name: Enable Auto-merge
  if: success()
  run: |
    gh pr merge --auto --squash task/${{ inputs.taskId }}
  env:
    GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
```

### 2. Improve run-task.mjs

- Add better error handling for Claude API responses
- Ensure proper commit message format
- Add timeout handling (max 5 min for API call)
- Log all steps clearly

### 3. Update apply-patch.mjs

- Handle edge cases (file not found, malformed patch)
- Add validation before writing files
- Support for creating directories

### 4. Ensure PROMPT_ENGINEER.md is complete

- Clear instructions for Claude on output format
- No secrets in code
- Proper error handling patterns

## Acceptance Criteria

- [ ] `engineer.yml` includes auto-merge step
- [ ] Manual trigger of workflow with test TASK completes successfully
- [ ] PR is created with correct title and labels
- [ ] Auto-merge is enabled on PR
- [ ] REPORT is generated in `factory/results/`
- [ ] Commit has proper co-author attribution

## Test Plan

1. Create a simple test TASK (e.g., add a comment to a file)
2. Trigger workflow via Actions UI
3. Verify:
   - Branch created
   - Claude API called
   - Changes applied
   - Checks run
   - PR created
   - Auto-merge enabled
   - (After CI green) PR merged
4. Check REPORT file

## Rollback Plan

- Disable auto-merge in workflow
- Revert workflow changes

## Outputs Required

- `factory/results/TASK-0011-REPORT.md`
- PR_LINK
- CI_STATUS: green
