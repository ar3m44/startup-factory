# TASK-0012: Repo-driven Data Layer

**Priority**: P1
**Type**: Feature
**Dependencies**: TASK-0010

## Context

The UI currently uses hardcoded fixture data. We need a data layer that reads real data from the repository:
- `factory/state.json` - ventures, signals, stats
- `factory/tasks/*.md` - task files
- `factory/results/*.md` - report files
- `factory/audit/*.md` - audit entries
- `ventures/*/` - venture directories

This enables the UI to show actual Factory state without external databases.

## Scope

- `src/lib/data/` - new directory for data loading
- `src/lib/data/loader.ts` - main data loading functions
- `src/lib/data/parsers.ts` - markdown/frontmatter parsing
- `src/lib/data/types.ts` - data types for UI
- Update `/api/state` to use new loader (optional)

## Non-Goals

- No external database (Postgres, SQLite, etc.)
- No caching layer (keep simple, rely on Next.js caching)
- No write operations (read-only)
- No real-time updates (static reads)

## Description

### 1. Create data loader module

```typescript
// src/lib/data/loader.ts
export async function loadFactoryState(): Promise<FactoryState>
export async function loadTasks(): Promise<Task[]>
export async function loadTask(taskId: string): Promise<Task | null>
export async function loadAuditEntries(): Promise<AuditEntry[]>
export async function loadVentures(): Promise<Venture[]>
export async function loadVenture(ventureId: string): Promise<Venture | null>
```

### 2. Create markdown parser

Parse TASK files with structure:
- Title from `# TASK-XXXX: Title`
- Priority from `**Priority**: P0`
- Status inferred from existence of REPORT
- Content as markdown

### 3. Create types

```typescript
// src/lib/data/types.ts
export interface TaskData {
  id: string;
  title: string;
  priority: 'P0' | 'P1' | 'P2';
  status: 'pending' | 'in_progress' | 'done';
  content: string;
  reportExists: boolean;
  prUrl?: string;
  createdAt: string;
  updatedAt: string;
}

export interface AuditEntryData {
  id: string;
  timestamp: string;
  actor: string;
  action: string;
  result: string;
  ventureId?: string;
  content: string;
}
```

### 4. File system access

Use Node.js `fs` module with `fs/promises`:
- Works in Server Components
- Works in API routes
- Does NOT work in client components (which is fine)

## Acceptance Criteria

- [ ] `src/lib/data/loader.ts` exports all functions
- [ ] `loadFactoryState()` reads `factory/state.json`
- [ ] `loadTasks()` reads all `factory/tasks/*.md` files
- [ ] `loadAuditEntries()` reads all `factory/audit/*.md` files
- [ ] Functions work in Server Components
- [ ] TypeScript strict mode passes
- [ ] No runtime errors on missing files (graceful fallback)

## Test Plan

1. Import loader in a Server Component
2. Call `loadTasks()` and verify it returns task data
3. Call `loadAuditEntries()` and verify audit data
4. Verify data matches actual files in repo
5. Run `npm run build` - should pass

## Rollback Plan

- Remove `src/lib/data/` directory
- Revert any component changes

## Outputs Required

- `factory/results/TASK-0012-REPORT.md`
- PR_LINK
- CI_STATUS: green
